'''
# package/controllers/petshop.py
import sys
import os
import json
from typing import Any, Dict

# Ajusta o caminho para que possamos importar as classes dos modelos
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Importando classes de MODELO (POO)
from models.cliente import Cliente
from models.veterinario import Veterinario
from models.cachorro import Cachorro
from models.gato import Gato
from models.atendimento import Atendimento
# Importando o DataRecord (Para persistência de dados no Nível 3)
from controllers.data_record import DataRecord 

class PetShopApp:
    """
    Controlador principal do sistema Pet Shop.
    Responsável pela interface do menu, validação de dados e orquestração de objetos.
    """
    def __init__(self):
        print("--- Inicializando o Sistema Pet Shop ---")
        
        # Estruturas de dados (Composição: O App é composto por estas listas)
        self.clientes = []
        self.veterinarios = []
        self.animais = []
        self.atendimentos = []

        # Menu de opções (Nível 2)
        self.opcoes: Dict[str, Any] = {
            '1': self.menu_cadastros,
            '2': self.registrar_atendimento,
            '3': self.visualizar_relatorios,
            '4': self.sair
        }
        
        # Submenu de Cadastros
        self.opcoes_cadastros: Dict[str, Any] = {
            '1': self.cadastrar_cliente,
            '2': self.cadastrar_veterinario,
            '3': self.cadastrar_animal,
            '4': lambda: True # Retorna ao menu principal
        }
    
    # --- MÉTODOS DE UTILIDADE E VALIDAÇÃO ---

    def _validar_numero(self, prompt: str, tipo: type = float) -> float | int:
        """VALIDAÇÃO: Garante que a entrada do usuário seja um número (float ou int)."""
        while True:
            try:
                valor = input(prompt)
                return tipo(valor)
            except ValueError:
                print("ERRO DE VALIDAÇÃO: Por favor, insira apenas números.")
                
    def _validar_string_nao_vazia(self, prompt: str) -> str:
        """VALIDAÇÃO: Garante que a entrada do usuário não seja vazia."""
        while True:
            valor = input(prompt).strip()
            if valor:
                return valor
            print("ERRO DE VALIDAÇÃO: O campo não pode estar vazio.")


    def _encontrar_objeto(self, lista: list, atributo: str, valor: str):
        """Busca um objeto na lista pelo valor de um atributo (e.g., buscar animal pelo nome)."""
        for obj in lista:
            if getattr(obj, atributo, None) == valor:
                return obj
        return None

    # --- MÉTODOS DE MENU ---

    def menu_principal(self):
        """Exibe o menu principal e processa a escolha do usuário."""
        print("\n=== Sistema Pet Shop ===")
        print("1. Cadastros (Cliente, Veterinário, Animal)")
        print("2. Registrar Atendimento/Serviço")
        print("3. Visualizar Relatórios")
        print("4. Sair")
        
        output = True
        while output:
            escolha = input("Escolha uma opção (1-4): ")
            action = self.opcoes.get(escolha, self.default)
            if not action():
                break

    def menu_cadastros(self):
        """Exibe o menu de cadastros."""
        print("\n--- Menu de Cadastros ---")
        print("1. Cadastrar Cliente")
        print("2. Cadastrar Veterinário")
        print("3. Cadastrar Animal")
        print("4. Voltar")

        while True:
            escolha = input("Escolha uma opção (1-4): ")
            action = self.opcoes_cadastros.get(escolha)
            if action:
                if escolha == '4':
                    return True # Volta ao menu principal
                if not action():
                    break # Saída forçada por erro
            else:
                self.default()
        
    def default(self):
        print('Opção inválida. Escolha um número de 1 a 4.')
        return True

    def sair(self):
        print('Obrigado! Saindo do programa.')
        return False

    # --- MÉTODOS DE CADASTRO (CRIAÇÃO DE OBJETOS) ---

    def cadastrar_cliente(self):
        print("\n--- NOVO CLIENTE ---")
        nome = self._validar_string_nao_vazia("Nome do Cliente: ")
        cpf = self._validar_string_nao_vazia("CPF: ")
        telefone = self._validar_string_nao_vazia("Telefone: ")
        
        # CRIAÇÃO DO OBJETO CLIENTE (Herança)
        novo_cliente = Cliente(nome, cpf, telefone)
        self.clientes.append(novo_cliente)
        print(f"\nSucesso! Cliente '{nome}' cadastrado.")
        return True

    def cadastrar_veterinario(self):
        print("\n--- NOVO VETERINÁRIO ---")
        nome = self._validar_string_nao_vazia("Nome do Veterinário: ")
        crm = self._validar_string_nao_vazia("CRM (Registro Profissional): ")
        especialidade = self._validar_string_nao_vazia("Especialidade: ")
        cpf = self._validar_string_nao_vazia("CPF: ")
        
        # CRIAÇÃO DO OBJETO VETERINARIO (Herança)
        novo_vet = Veterinario(nome, cpf, crm, especialidade)
        self.veterinarios.append(novo_vet)
        print(f"\nSucesso! Veterinário '{nome}' cadastrado.")
        return True

    def cadastrar_animal(self):
        print("\n--- NOVO ANIMAL ---")
        
        # 1. Seleção do Cliente (Associação)
        cliente_nome = self._validar_string_nao_vazia("Nome do Cliente (Dono): ")
        cliente_dono = self._encontrar_objeto(self.clientes, 'nome', cliente_nome)
        
        if not cliente_dono:
            print(f"ERRO: Cliente '{cliente_nome}' não encontrado. Cadastre-o primeiro.")
            return True
            
        especie = self._validar_string_nao_vazia("Espécie (Cachorro/Gato): ").strip().capitalize()
        nome = self._validar_string_nao_vazia("Nome do Animal: ")
        raca = self._validar_string_nao_vazia("Raça: ")
        idade = self._validar_numero("Idade: ", int)
        peso = self._validar_numero("Peso (kg): ")

        # 2. CRIAÇÃO DO OBJETO ANIMAL (Herança e Polimorfismo)
        if especie == 'Cachorro':
            novo_animal = Cachorro(nome, raca, idade, peso)
        elif especie == 'Gato':
            novo_animal = Gato(nome, raca, idade, peso)
        else:
            print("ERRO: Espécie inválida. Apenas Cachorro ou Gato.")
            return True

        self.animais.append(novo_animal)
        cliente_dono.adicionar_animal(novo_animal) # Associa o animal ao cliente
        print(f"\nSucesso! Animal '{nome}' cadastrado e associado ao cliente {cliente_dono.nome}.")
        return True

    # --- MÉTODOS DE NEGÓCIO (ASSOCIAÇÃO E POLIMORFISMO) ---

    def registrar_atendimento(self):
        print("\n=== REGISTRAR ATENDIMENTO/SERVIÇO ===")
        
        # Validação de Pré-condições
        if not self.clientes or not self.veterinarios or not self.animais:
            print("ERRO: É necessário cadastrar pelo menos 1 cliente, 1 veterinário e 1 animal antes.")
            return True

        # 1. Selecionar Cliente e Animal
        cliente_nome = self._validar_string_nao_vazia("Nome do Cliente: ")
        cliente_obj = self._encontrar_objeto(self.clientes, 'nome', cliente_nome)
        if not cliente_obj:
            print("Cliente não encontrado.")
            return True

        animal_nome = self._validar_string_nao_vazia("Nome do Animal a ser atendido: ")
        # Busca o animal na lista do cliente (melhor associação)
        animal_obj = self._encontrar_objeto(cliente_obj.animais, 'nome', animal_nome) 
        if not animal_obj:
            print(f"Animal '{animal_nome}' não encontrado na lista de animais do cliente.")
            return True

        # 2. Selecionar Veterinário
        vet_crm = self._validar_string_nao_vazia("CRM do Veterinário responsável: ")
        vet_obj = self._encontrar_objeto(self.veterinarios, 'crm', vet_crm)
        if not vet_obj:
            print("Veterinário com este CRM não encontrado.")
            return True

        # 3. Informações e Cálculo Base
        servico = self._validar_string_nao_vazia("Serviço (Consulta, Banho, Tosa, etc.): ")
        valor_base = self._validar_numero("Valor base do serviço (R$): ")
        diagnostico = input("Diagnóstico/Observações (opcional): ")
        
        # 4. Criação do Objeto Atendimento (Associação e Composição)
        novo_atendimento = Atendimento(
            cliente=cliente_obj,
            veterinario=vet_obj,
            animal=animal_obj,
            servico=servico,
            valor_base=valor_base,
            diagnostico=diagnostico
        )
        
        # Adicionar procedimentos (Composição)
        print("\n--- Adicionar Procedimentos Extras ---")
        while True:
            proc = input("Descreva o Procedimento (Ex: 'Vacina V10'), ou digite 'N' para Não: ")
            if proc.lower() == 'n':
                break
            if self._validar_string_nao_vazia(proc):
                novo_atendimento.adicionar_procedimento(proc)
            
        self.atendimentos.append(novo_atendimento)
        
        print("\nSucesso! Atendimento Registrado.")
        print(novo_atendimento.exibir_resumo())

        return True

    # --- MÉTODOS DE RELATÓRIO (POLIMORFISMO E INFORMAÇÃO) ---
    
    def visualizar_relatorios(self):
        print("\n=== RELATÓRIOS DO SISTEMA ===")
        print("1. Risco Veterinário por Animal (Polimorfismo)")
        print("2. Histórico de Atendimentos")
        
        escolha = input("Escolha o relatório (1 ou 2): ")
        
        if escolha == '1':
            self.relatorio_risco_polimorfico()
        elif escolha == '2':
            self.relatorio_historico()
        else:
            print("Opção de relatório inválida.")
        
        return True

    def relatorio_risco_polimorfico(self):
        print("\n--- RELATÓRIO DE RISCO VETERINÁRIO ---")
        if not self.animais:
            print("Nenhum animal cadastrado.")
            return

        for animal in self.animais:
            # CHAMADA POLIMÓRFICA: O Cachorro e o Gato respondem de forma diferente
            risco = animal.validar_necessidade_veterinaria()
            print(f"- {animal.nome} ({animal.especie} - {animal.raca})")
            print(f"  Risco Prioridade: {risco} (Idade: {animal.idade} anos, Peso: {animal.peso} kg)")
        
    def relatorio_historico(self):
        print("\n--- HISTÓRICO DE ATENDIMENTOS ---")
        if not self.atendimentos:
            print("Nenhum atendimento registrado.")
            return
            
        for index, atendimento in enumerate(self.atendimentos, 1):
            print(f"\n[ATENDIMENTO #{index}]")
            print(atendimento.exibir_resumo())
            
# --- Inicialização do Aplicativo (Requer main.py na raiz) ---

# if __name__ == '__main__':
#     app = PetShopApp()
#     app.menu_principal()

'''
